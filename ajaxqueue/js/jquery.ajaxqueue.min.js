(function($){$.fn.extend({ajaxqueue:function(options){var defaults={concurrentActions:0};var opts=defaults;if(options)opts=$.extend(defaults,options);var active=[];var queue=[];var idCount=0;var preAction=null;var postAddAction=null;var postAction=null;var id=Math.uuid();this.active=function(){var actives=[];for(var index=0;index<active.length;index++)actives.push(active[index].action.name);return actives};this.waiting=function(){var queued=[];for(var index=0;index<queue.length;index++)queued.push(queue[index].action.name);
return queued};this.id=function(){return id};this.addAction=function(params){var newAction=ajaxAction(params);if(opts.concurrentActions===0||active.length<opts.concurrentActions){active.push({id:newAction.id,action:newAction});newAction.ajax()}else queue.push({id:newAction.id,action:newAction});if(postAddAction)postAddAction();idCount++};this.cancelAction=function(actionName){var matchesName=function(item){return item.action.name===actionName};var cancelActive=$.grep(active,matchesName);var cancelQueue=
$.grep(queue,matchesName);for(var index=0;index<cancelActive.length;index++){removeActionFromArray(cancelActive[index].id,active);cancelActive[index].action.cancel()}for(var index=0;index<cancelQueue.length;index++){removeActionFromArray(cancelQueue[index].id,queue);cancelQueue[index].action.cancel()}startNextAction()};this.clearWaitingActions=function(){queue=[]};this.setPostAddAction=function(fn){postAddAction=fn};this.setPreAction=function(fn){preAction=fn};this.setPostAction=function(fn){postAction=
fn};function completeAction(actionId){var result=removeActionFromArray(actionId,active);if(postAction)postAction();startNextAction();return result}function startNextAction(){while(opts.concurrentActions>0&&queue.length>0&&active.length<opts.concurrentActions){var nextActionObject=queue.shift();active.push({id:nextActionObject.id,action:nextActionObject.action});if(preAction)preAction();nextActionObject.action.ajax()}}function removeActionFromArray(actionId,array){var spliceIndex=-1;for(var index=
0;index<array.length;index++)if(array[index].id===actionId){spliceIndex=index;break}if(spliceIndex>=0){array.splice(spliceIndex,1);return true}return false}var ajaxAction=function(params){var actionSuccess,actionError;var actionId="action_"+idCount;var paramsSuccess=params.success;if(paramsSuccess.length===1)actionSuccess=function(data){if(completeAction(actionId))paramsSuccess(data)};else if(paramsSuccess.length===2)actionSuccess=function(data,textStatus){if(completeAction(actionId))paramsSuccess(data,
textStatus)};else if(paramsSuccess.length===3)actionSuccess=function(data,textStatus,request){if(completeAction(actionId))paramsSuccess(data,textStatus,request)};params.success=actionSuccess;var paramsError;if(params.error){paramsError=params.error;actionError=function(XMLHttpRequest,textStatus,errorThrown){if(completeAction(actionId))paramsError(XMLHttpRequest,textStatus,errorThrown)};params.error=actionError}return{id:actionId,name:params.name,ajax:function(){$.ajax(params)},cancel:function(){if(params.cancel)if(params.context)params.cancel.apply(params.context,
[]);else params.cancel()}}};return this}})})(jQuery);